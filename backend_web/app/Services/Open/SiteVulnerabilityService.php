<?php
/**
 * @author Eduardo Acevedo Farje.
 * @link www.eduardoaf.com
 * @name SiteVulnerabilityService
 * @file SiteVulnerabilityService.php
 * @version 1.0.0
 * @date 23-11-2020 20:46
 * @observations
 */
namespace App\Services\Open;

use App\Component\FetchComponent as Fetch;
use App\Services\BaseService;

class SiteVulnerabilityService extends BaseService
{
    private $endpoints = [];
    private $token = null;

    private function _get_fetch($url)
    {
        return (new Fetch($url))
                    ->is_debug()
            ;
    }

    private function _load_endpoints()
    {
        if(!$this->endpoints){
            $url = $this->get_env("API_IPBLOCKER_URL");
            $this->endpoints =[
                "login" =>"$url/security/login",
                "read"  =>"$url/read",
            ];
        }
    }

    private function _login()
    {
        if(!$this->token) {
            $urllogin = $this->endpoints["login"];
            $user = $this->get_env("API_IPBLOCKER_USERNAME");
            $password = $this->get_env("API_IPBLOCKER_PASSWORD");
            $this->token = $this->_get_fetch($urllogin)
                ->add_header("origin","http://eduardoaf.com")
                ->add_post("user", $user)
                ->add_post("password", $password)
                ->get_array()["data"]["token"] ?? ""
            ;
            if(!$this->token) new \Exception("No token resolved");
        }
    }

    public function get_top50()
    {
        $this->_load_endpoints();
        $this->_login();
        $urlread = $this->endpoints["read"];
        $data = $this->_get_fetch($urlread)

                    ->add_header("origin", "http://eduardoaf.com")

                    ->add_get("context","c3")
                    ->add_get("schemainfo","db-security")

                    ->add_post("apify-usertoken", $this->token)

                    ->add_post("queryparts[table]","app_ip_request r")
                    ->add_post("queryparts[foundrows]",1)
                    ->add_post("queryparts[fields][0]","r.id")
                    ->add_post("queryparts[fields][1]","r.remote_ip")
                    ->add_post("queryparts[where][2]", "r.domain NOT LIKE '%sitelock.com%'")
                    ->add_post("queryparts[orderby][0]", "r.id DESC")
                    ->add_post("queryparts[limit][perpage]", 50)
                    ->add_post("queryparts[limit][regfrom]", 0)
                    //->get()
                    ->get_array()
        ;
        dd($data);
        return $data;
    }

    public function get(){}

    private function _test()
    {
        $url = $this->get_env("API_CURL_TEST");
        //$url = "http://www.cualesmiip.com/";
        $fetch = (new Fetch($url))
            ->is_debug()

            ->add_header("accept","application/json, text/plain, */*")

            ->add_header("accept-encoding","gzip, deflate, br")
            ->add_header("accept-language","es-ES,es;q=0.9,en;q=0.8,lt;q=0.7")

            ->add_header("cache-control","no-cache")

            //->add_header("content-length","3570")  //esto da nok
            //->add_header("content-type","multipart/form-data; boundary=----WebKitFormBoundaryMP5JCqhrtFhhHO3N") //esto da nok
            //->add_header("content-type","multipart/form-data") nok, no envia post

            ->add_header("origin", "https://ipblocker.theframework.es")
            ->add_header("pragma", "no-cache")
            ->add_header("referer", "https://ipblocker.theframework.es/")
            ->add_header("sec-fetch-dest","empty")
            ->add_header("sec-fetch-mode", "cors")
            ->add_header("sec-fetch-site", "same-site")
            ->add_header("user-agent","Mozilla/5.0 (Macintosh; Intel Mac OS X 11_1_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36")


            ->add_get("context","c3")
            ->add_get("schemainfo","db-security")

            ->add_post("apify-usertoken","UnVCd0w5TUQweHNzOWJ3RTUrK3poMTUyOVdKVTBmNmNENVh1MnFWL3pSUDE4UWZUUUg0Yy9HTHNiYzlDZklpeTQ3cE9LMFdObVRDUnlGZy96dkFCQTFtYUkvZnZuMGRFdGhSNWNwT3JheWt1WGdkYjB0emJwNnhNaXdBNW1DWFlOMTZYRzVMMk1rUlVUL00wS1YyUU1tb0FaTTFZNUtRY1dQd1RpSWR4dS8wPQ==")
            ->add_post("queryparts[table]","app_ip_request")
            ->add_post("queryparts[foundrows]",1)
            ->add_post("queryparts[fields][0]","r.id")
            ->add_post("queryparts[fields][1]","r.remote_ip")
            ->add_post("queryparts[joins][0]","LEFT JOIN app_ip_blacklist bl ON r.remote_ip = bl.remote_ip")
            ->add_post("queryparts[where][2]", "i.whois NOT LIKE '%sitelock.com%")
            ->add_post("queryparts[orderby][0]", "r.id DESC")
            ->add_post("queryparts[limit][perpage]", 50)
            ->add_post("queryparts[limit][regfrom]", 0)
            ->get();
        echo $fetch;
    }
}
