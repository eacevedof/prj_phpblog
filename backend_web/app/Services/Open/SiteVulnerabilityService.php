<?php
/**
 * @author Eduardo Acevedo Farje.
 * @link www.eduardoaf.com
 * @name SiteVulnerabilityService
 * @file SiteVulnerabilityService.php
 * @version 1.0.0
 * @date 23-11-2020 20:46
 * @observations
 */
namespace App\Services\Open;

use App\Component\FetchComponent as Fetchx;
use App\Services\BaseService;

class SiteVulnerabilityService extends BaseService
{
    private $input;
    private $clean;
    private $errors;

    public function __construct($input=[])
    {
        $this->input = $input;
        //$this->_load_clean();
    }

    private function _load_clean()
    {
        $this->clean = [
            "pattern" => $this->input["pattern"] ?? "",
            "flags"    => $this->input["flags"] ?? "",
            "text"    => $this->input["text"] ?? "",
        ];
    }

    private function _post()
    {
        $url = $this->get_env("API_IPBLOCKER_URL")."/read?context=c3&schemainfo=db-security";
        $data = [];
        //$curl = new Curl();
        //refactor de Curl
    }

    private function _get_token()
    {
        //login contra read-only
        $urllogin = $this->get_env("API_IPBLOCKER_URL")."/security/login";
        $user = $this->get_env("API_IPBLOCKER_USERNAME");
        $password = $this->get_env("API_IPBLOCKER_PASSWORD");
    }

    public function get_top50()
    {
        $token = $this->_get_token();
        //llamada a ipblocker
    }

    public function get()
    {
        $url = $this->get_env("API_CURL_TEST");
        $fetch = (new Fetchx($url))

            ->add_header("accept","application/json, text/plain, */*")
            ->add_header("accept-encoding","gzip, deflate, br")
            ->add_header("accept-language","es-ES,es;q=0.9,en;q=0.8,lt;q=0.7")
            ->add_header("cache-control","no-cache")
            ->add_header("content-length","3570")
            ->add_header("content-type","multipart/form-data; boundary=----WebKitFormBoundaryMP5JCqhrtFhhHO3N")
            ->add_header("origin", "https://ipblocker.theframework.es")
            ->add_header("pragma", "no-cache")
            ->add_header("referer", "https://ipblocker.theframework.es/")
            ->add_header("sec-fetch-dest","empty")
            ->add_header("sec-fetch-mode", "cors")
            ->add_header("sec-fetch-site", "same-site")
            ->add_header("user-agent","Mozilla/5.0 (Macintosh; Intel Mac OS X 11_1_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36")

            ->add_get("context","c3")
            ->add_get("schemainfo","db-security")
            ->add_post("queryparts[table]","app_ip_request")
            ->add_post("queryparts[foundrows]",1)
            ->add_post("queryparts[fields][0]","r.id")
            ->add_post("queryparts[fields][1]","r.remote_ip")
            ->get();
        echo $fetch;
    }
}

/*











queryparts[table]: app_ip_request r
queryparts[foundrows]: 1
queryparts[distinct]: 1
queryparts[fields][0]: r.id
queryparts[fields][1]: r.remote_ip
queryparts[fields][2]: i.country
queryparts[fields][3]: i.whois
queryparts[fields][4]: r.domain
queryparts[fields][5]: r.request_uri
queryparts[fields][6]: r.`get`
queryparts[fields][7]: CASE WHEN r.`get`!='' THEN 'GET' ELSE '' END hasget
queryparts[fields][8]: r.post
queryparts[fields][9]: CASE WHEN r.`post`!='' THEN 'POST' ELSE '' END haspost
queryparts[fields][10]: r.insert_date
queryparts[fields][11]: bl.insert_date bl_date
queryparts[fields][12]: bl.reason
queryparts[fields][13]: CASE WHEN bl.id IS NULL THEN '' ELSE 'INBL' END inbl
queryparts[joins][0]: LEFT JOIN app_ip_blacklist bl ON r.remote_ip = bl.remote_ip
queryparts[joins][1]: LEFT JOIN app_ip i ON r.remote_ip = i.remote_ip
queryparts[where][0]: i.whois NOT LIKE '%google%'
queryparts[where][1]: i.whois NOT LIKE '%msn%'
queryparts[where][2]: i.whois NOT LIKE '%sitelock.com%'
queryparts[orderby][0]: r.id DESC
queryparts[limit][perpage]: 50
queryparts[limit][regfrom]: 0

apify-usertoken: UnVCd0w5TUQweHNzOWJ3RTUrK3poMTUyOVdKVTBmNmNENVh1MnFWL3pSUDE4UWZUUUg0Yy9HTHNiYzlDZklpeTQ3cE9LMFdObVRDUnlGZy96dkFCQTFtYUkvZnZuMGRFdGhSNWNwT3JheWt1WGdkYjB0emJwNnhNaXdBNW1DWFlOMTZYRzVMMk1rUlVUL00wS1YyUU1tb0FaTTFZNUtRY1dQd1RpSWR4dS8wPQ==

*/
